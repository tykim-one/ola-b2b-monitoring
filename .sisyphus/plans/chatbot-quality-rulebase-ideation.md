# 챗봇 답변 퀄리티 판별 룰베이스 아이디에이션

> **목적**: LLM 분석 전 룰베이스로 문제 응답을 최대한 걸러내어 비용 절감
> **범위**: 아이디어 정리 (구현은 별도 진행)
> **데이터**: BigQuery 챗봇 로그 (timestamp, tenant_id, success, tokens, user_input, llm_response, session_id, x_enc_data 등)
> **작성일**: 2026-02-04

---

## 현재 구현된 규칙 (참고)

| 필드 | 설명 |
|------|------|
| `output_tokens` < 임계값 | 저토큰 응답 |
| `token_ratio` (output/input) | 토큰 비율 이상 |
| `llm_response` 키워드 포함/미포함 | "죄송합니다", "찾을 수 없습니다" 등 |
| `success` = false | API 실패 |
| `user_input` 텍스트 매칭 | 사용자 입력 패턴 |

---

## 카테고리 1: 텍스트 패턴 기반 규칙

### 1.1 응답 잘림(Truncation) 탐지
- **조건**: 응답이 완전한 문장으로 끝나지 않음
  - 마지막 50자에 종결어미(다/요/습니다/세요) 또는 마침표 없음
  - 코드블록(```) 열고 닫지 않음
  - 괄호/인용부호 짝이 안 맞음
- **필드**: `llm_response`
- **근거**: 토큰 한도 도달 또는 생성 중단 → 불완전한 답변
- **난이도**: 하

### 1.2 반복 루프 탐지
- **조건**:
  - 동일 문장(20자 이상)이 2회 이상 반복
  - 5-gram 이상 연속 시퀀스가 3회 이상 등장
  - 같은 단락(50자 이상)이 그대로 반복
- **필드**: `llm_response`
- **근거**: 모델 생성 루프 → 심각한 품질 저하
- **난이도**: 중

### 1.3 과도한 사과/거부 패턴
- **조건**:
  - "죄송" 계열 표현이 2회 이상 등장
  - 사과 후 유용한 내용 없이 종료 (사과 비율 > 50%)
  - "도움을 드리기 어렵", "답변할 수 없", "제가 할 수 없는" 등 거부 표현
- **필드**: `llm_response`
- **근거**: 답변 거부 또는 무능력 → 사용자 불만족
- **난이도**: 하

### 1.4 정형화된 에러 응답 탐지
- **조건**:
  - "입력하신 내용을 정확히 이해하지 못했습니다" (예시 데이터에서 발견)
  - "다시 질문해 주시겠어요?" 로만 끝나는 응답
  - "잠시 후 다시 시도" 류의 시스템 에러 메시지
- **필드**: `llm_response`
- **근거**: 챗봇이 질문을 처리하지 못한 명확한 실패
- **난이도**: 하

### 1.5 마크다운 깨짐 탐지
- **조건**:
  - 열린 `**`가 닫히지 않음 (bold 깨짐)
  - 테이블 행의 컬럼 수 불일치
  - 번호 리스트에서 번호 건너뜀 (1, 2, 4...)
  - URL 형식 깨짐 `[text](불완전`
- **필드**: `llm_response`
- **근거**: 렌더링 깨짐 → UX 저하
- **난이도**: 중

### 1.6 언어 불일치 탐지
- **조건**:
  - 한국어 질문에 영어로 응답 (또는 반대)
  - 응답 중간에 갑자기 언어 전환 (코드/용어 제외)
  - 한글 비율 < 30% (코드블록 제외한 텍스트에서)
- **필드**: `user_input`, `llm_response`
- **근거**: 언어 미스매치 → 사용자가 이해 불가
- **난이도**: 하

---

## 카테고리 2: 통계 기반 규칙

### 2.1 응답 길이 vs 질문 복잡도 불일치
- **조건**:
  - 질문이 긴데(input_tokens > 100) 응답이 매우 짧음(output_tokens < 50)
  - 단순 질문(input_tokens < 20)인데 응답이 과도하게 김(output_tokens > 2000)
- **필드**: `input_tokens`, `output_tokens`
- **근거**: 질문 대비 비정상적인 응답 길이 → 질문을 제대로 처리 못했을 가능성
- **난이도**: 하

### 2.2 토큰 효율성 이상
- **조건**:
  - 응답 글자수 / output_tokens < 2.0 (한국어 기준, 비정상적으로 낮은 글자 효율)
  - output_tokens가 동일 tenant의 중앙값 대비 3배 이상
- **필드**: `output_tokens`, `llm_response`
- **근거**: 비효율적 토큰 사용 → gibberish 또는 인코딩 이상
- **난이도**: 중 (중앙값 계산을 위한 통계 쿼리 필요)

### 2.3 어휘 다양성 부족 (Type-Token Ratio)
- **조건**:
  - 고유단어수 / 전체단어수 < 0.3 (50단어 이상인 응답)
  - 특정 단어가 전체의 10% 이상 차지
- **필드**: `llm_response`
- **근거**: 반복적이고 빈약한 응답 → 모델 품질 문제
- **난이도**: 중 (형태소 분석 필요 시 상)

### 2.4 문장 길이 분산 이상
- **조건**:
  - 모든 문장이 비슷한 길이 (표준편차 < 3단어) → 기계적 느낌
  - 평균 문장 > 60단어 → 가독성 저하
  - 평균 문장 < 5단어 → 내용 부실
- **필드**: `llm_response`
- **근거**: 자연스러운 텍스트는 문장 길이에 적절한 분산이 있음
- **난이도**: 하

---

## 카테고리 3: 세션/컨텍스트 기반 규칙

### 3.1 즉시 재질문 탐지
- **조건**:
  - 같은 x_enc_data가 5분 이내에 유사한 질문 재전송
  - 키워드 겹침률 > 70% 또는 편집 거리 < 30%
- **필드**: `x_enc_data`, `user_input`, `timestamp`
- **근거**: 이전 응답이 불만족스러워서 재시도 → **이전 응답**이 문제
- **난이도**: 중

### 3.2 세션 이탈 탐지
- **조건**:
  - 사용자가 활발히 대화 중(직전 1시간 3건 이상) 특정 응답 후 24시간 미접속
  - 마지막 응답이 해당 사용자의 마지막 활동
- **필드**: `session_id`, `x_enc_data`, `timestamp`
- **근거**: 응답에 실망하여 서비스 이탈
- **난이도**: 상 (시계열 분석 필요)

### 3.3 연속 오류 클러스터
- **조건**:
  - 같은 tenant에서 10분 내 5건 이상 문제 응답
  - 같은 session_id에서 연속 2건 이상 문제 응답
- **필드**: `tenant_id`, `session_id`, `timestamp`, `success`
- **근거**: 시스템적 장애 또는 특정 유형 질문에 대한 일괄 실패
- **난이도**: 중

### 3.4 좌절 에스컬레이션 패턴
- **조건**:
  - 같은 세션에서 message_length가 연속 증가 (20% 이상씩)
  - 같은 질문을 점점 더 상세하게 재작성
  - "사람", "상담원", "직원" 등 에스컬레이션 키워드
- **필드**: `session_id`, `user_input`, `message_length`
- **근거**: 사용자 좌절 → 이전 응답들이 모두 불만족
- **난이도**: 중

### 3.5 부정적 후속 반응
- **조건**:
  - 응답 직후 사용자가 "아니", "틀렸", "잘못", "wrong" 등 부정어 사용
  - "다시", "다른", "제대로" 등 재요청 표현
- **필드**: `session_id`, `user_input` (다음 메시지)
- **근거**: 직접적인 사용자 불만족 신호
- **난이도**: 하

---

## 카테고리 4: 질문-응답 관련성 규칙

### 4.1 키워드 겹침률
- **조건**:
  - 질문의 핵심 키워드(명사, 고유명사)가 응답에 하나도 없음
  - 겹침률 < 10%
- **필드**: `user_input`, `llm_response`
- **근거**: 질문과 무관한 응답
- **난이도**: 중 (형태소 분석 또는 단순 공백 분리)

### 4.2 질문 유형별 기대 패턴 미충족
- **조건**:
  - "얼마" / "가격" 질문 → 응답에 숫자+단위 없음
  - "언제" / "시간" 질문 → 응답에 날짜/시간 표현 없음
  - "왜" / "이유" 질문 → 응답에 인과관계 표현("때문", "이유는") 없음
  - "어떻게" 질문 → 응답에 절차/방법 표현("먼저", "다음", "단계") 없음
- **필드**: `user_input`, `llm_response`
- **근거**: 질문 유형에 맞지 않는 응답 형식
- **난이도**: 중

### 4.3 질문 되돌리기(반문) 탐지
- **조건**:
  - 사용자가 질문(? 포함)했는데 응답도 2개 이상 질문으로 구성
  - 응답이 사용자 질문을 그대로 반복(rephrasing)
  - 실질적 답변 없이 추가 정보만 요구
- **필드**: `user_input`, `llm_response`
- **근거**: 답변 대신 질문으로 회피
- **난이도**: 하

---

## 카테고리 5: 금융 도메인 특화 규칙

### 5.1 면책 조항 누락 탐지
- **조건**:
  - 투자 관련 키워드("주가", "수익률", "매수", "매도", "투자") 포함 응답
  - BUT 면책 표현("투자 책임", "참고 용도", "투자 권유가 아님") 없음
- **필드**: `llm_response`
- **근거**: **법적 리스크** - 금융투자업 규정 위반 가능
- **난이도**: 하
- **심각도**: CRITICAL

### 5.2 단정적 투자 표현 탐지
- **조건**:
  - "확실히 오를", "100% 수익", "반드시 상승"
  - "무조건 사세요", "절대 안전", "손해 없는"
  - 확실성 표현 + 투자 행위 조합
- **필드**: `llm_response`
- **근거**: **법적 리스크** - 불확실한 미래를 확정적으로 표현 금지
- **난이도**: 하 (정규식)
- **심각도**: CRITICAL

### 5.3 규제 금지어 탐지
- **조건**:
  - "원금 보장", "무위험 수익", "확정 수익률"
  - "보장된 이익", "위험 없는 투자"
- **필드**: `llm_response`
- **근거**: 자본시장법상 명시적 금지 표현
- **난이도**: 하 (키워드 매칭)
- **심각도**: CRITICAL

### 5.4 시점 정보 누락
- **조건**:
  - 가격/시세/수익률 등 시변 데이터 언급
  - BUT 시점 정보("2025년", "현재", "종가 기준", "기준일") 없음
- **필드**: `llm_response`
- **근거**: 어떤 시점의 데이터인지 모르면 투자 판단 오류 가능
- **난이도**: 중
- **심각도**: HIGH

### 5.5 숫자 범위 이상 탐지
- **조건**:
  - 수익률 > 1000% 또는 < -100%
  - 주가가 음수
  - 금리가 100% 초과
  - 비율이 0~100% 범위 밖
- **필드**: `llm_response`
- **근거**: 현실적으로 불가능한 수치 → 할루시네이션 가능성
- **난이도**: 중 (숫자+단위 추출 정규식)
- **심각도**: HIGH

### 5.6 종목 혼동 탐지
- **조건**:
  - 질문에서 언급한 종목명/코드가 응답에서 다른 종목으로 바뀜
  - "삼성전자" 질문에 "삼성SDI" 응답 등
- **필드**: `user_input`, `llm_response`
- **근거**: 종목 혼동은 금융 챗봇에서 가장 위험한 오류
- **난이도**: 상 (종목 DB 필요)
- **심각도**: CRITICAL

---

## 카테고리 6: 응답 시간/시스템 기반 규칙

### 6.1 버스트 에러 탐지
- **조건**:
  - 10분 내 같은 tenant에서 에러율이 평소 대비 3배 이상 증가
  - 특정 시간대에 집중된 오류
- **필드**: `timestamp`, `tenant_id`, `success`
- **근거**: 시스템적 장애 탐지
- **난이도**: 중

### 6.2 첫 메시지 품질 저하
- **조건**:
  - 세션의 첫 번째 메시지 응답이 후속 메시지 대비 오류율 2배 이상
- **필드**: `session_id`, `timestamp`
- **근거**: 컨텍스트 초기화 문제 또는 시스템 웜업 이슈
- **난이도**: 중

### 6.3 동일 질문 다른 품질
- **조건**:
  - 동일(유사) 질문에 대해 어떤 때는 정상, 어떤 때는 문제 응답
  - 같은 질문의 output_tokens 편차가 5배 이상
- **필드**: `user_input`, `output_tokens`, `llm_response`
- **근거**: 비결정적 응답 품질 → 시스템 불안정 또는 컨텍스트 문제
- **난이도**: 상

---

## 카테고리 7: 사용자 행동 기반 규칙

### 7.1 동일 질문 반복 (다수 사용자)
- **조건**:
  - 같은 질문(키워드 70% 이상 겹침)이 서로 다른 사용자로부터 10회 이상
  - 해당 질문에 대한 응답의 평균 output_tokens가 낮음
- **필드**: `user_input`, `x_enc_data`, `output_tokens`
- **근거**: 챗봇이 해결 못하는 공통 질문 = 제품 갭(product gap)
- **난이도**: 중

### 7.2 빠른 연속 질문 (Rapid Fire)
- **조건**:
  - 같은 사용자가 30초 내 3건 이상 메시지 전송
  - 각 메시지가 서로 다른 질문 (follow-up이 아님)
- **필드**: `x_enc_data`, `timestamp`, `user_input`
- **근거**: 이전 응답 불만으로 다양한 시도
- **난이도**: 하

---

## 우선순위 정리

### Tier 1 - 즉시 적용 가능 (난이도 하, 임팩트 높음)
| # | 규칙 | 카테고리 | 심각도 |
|---|------|----------|--------|
| 1 | 정형화된 에러 응답 탐지 (1.4) | 텍스트 | HIGH |
| 2 | 과도한 사과/거부 패턴 (1.3) | 텍스트 | HIGH |
| 3 | 응답 잘림 탐지 (1.1) | 텍스트 | HIGH |
| 4 | 언어 불일치 탐지 (1.6) | 텍스트 | MEDIUM |
| 5 | 면책 조항 누락 (5.1) | 금융 | CRITICAL |
| 6 | 단정적 투자 표현 (5.2) | 금융 | CRITICAL |
| 7 | 규제 금지어 (5.3) | 금융 | CRITICAL |
| 8 | 질문 되돌리기 탐지 (4.3) | 관련성 | MEDIUM |
| 9 | 부정적 후속 반응 (3.5) | 세션 | HIGH |

### Tier 2 - 단기 적용 (난이도 중, 임팩트 중-높음)
| # | 규칙 | 카테고리 | 심각도 |
|---|------|----------|--------|
| 10 | 반복 루프 탐지 (1.2) | 텍스트 | HIGH |
| 11 | 마크다운 깨짐 (1.5) | 텍스트 | MEDIUM |
| 12 | 응답 길이 vs 질문 복잡도 (2.1) | 통계 | MEDIUM |
| 13 | 키워드 겹침률 (4.1) | 관련성 | HIGH |
| 14 | 질문 유형별 기대 패턴 (4.2) | 관련성 | MEDIUM |
| 15 | 즉시 재질문 탐지 (3.1) | 세션 | HIGH |
| 16 | 연속 오류 클러스터 (3.3) | 세션 | HIGH |
| 17 | 시점 정보 누락 (5.4) | 금융 | HIGH |
| 18 | 숫자 범위 이상 (5.5) | 금융 | HIGH |
| 19 | 버스트 에러 (6.1) | 시스템 | HIGH |

### Tier 3 - 중기 적용 (난이도 상, 임팩트 중)
| # | 규칙 | 카테고리 |
|---|------|----------|
| 20 | 어휘 다양성 (2.3) | 통계 |
| 21 | 토큰 효율성 이상 (2.2) | 통계 |
| 22 | 세션 이탈 (3.2) | 세션 |
| 23 | 좌절 에스컬레이션 (3.4) | 세션 |
| 24 | 종목 혼동 (5.6) | 금융 |
| 25 | 동일 질문 다른 품질 (6.3) | 시스템 |
| 26 | 동일 질문 반복 - 다수 사용자 (7.1) | 행동 |

---

## 규칙 조합 전략 (복합 신호)

단일 규칙보다 **여러 약한 신호의 조합**이 더 정확합니다:

| 조합 예시 | 설명 | 신뢰도 |
|-----------|------|--------|
| 저토큰 + 사과패턴 | 짧은 응답 + 사과 = 답변 불능 | 매우 높음 |
| 키워드 겹침 낮음 + 재질문 | 관련 없는 응답 후 재시도 | 매우 높음 |
| 금융키워드 + 면책조항 누락 + 단정적 표현 | 규정 위반 복합 | CRITICAL |
| 반복 루프 + 고토큰 | 생성 루프에 빠져서 토큰 낭비 | 높음 |
| 연속 에러 + 버스트 | 시스템 장애 | 높음 |

---

## 구현 시 고려사항

### BigQuery SQL로 구현 가능한 규칙
- 토큰 기반 (이미 구현): 숫자 비교
- 키워드 기반: `LIKE`, `REGEXP_CONTAINS`
- 세션 기반: `LAG()`, `LEAD()` 윈도우 함수
- 통계 기반: `PERCENTILE_CONT()`, `STDDEV()`
- 시간 기반: `TIMESTAMP_DIFF()`, `COUNT() OVER (PARTITION BY ... ORDER BY ...)`

### 서버사이드(Node.js)에서 구현해야 하는 규칙
- 마크다운 구조 검증 (정규식 복잡)
- 형태소 분석 기반 규칙 (한국어 NLP 라이브러리 필요)
- 어휘 다양성 계산
- 문장 완성도 분석

### 임계값 튜닝 전략
1. 실제 데이터로 분포 확인 → 초기 임계값 설정
2. 오탐(false positive) 비율 모니터링
3. LLM 분석 결과로 규칙 정확도 피드백 루프 구성
4. tenant별 임계값 커스터마이징 (서비스 특성 반영)

---

## 참고 자료
- WhyLabs LangKit: https://github.com/whylabs/langkit
- RAGAS Framework: https://github.com/explodinggradients/ragas
- TruLens: https://www.trulens.org
- LangSmith: https://www.langchain.com/langsmith
