# 리포트 데이터 품질 모니터링 시스템 아이디어

## 개요

서비스 DB에서 호출하는 리포트 타겟 데이터(AI 주식, 원자재, 환율, 배당주)의 품질을 모니터링하여 리포트 발행 오류를 사전에 방지하고 데이터 신뢰성을 높이는 시스템.

---

## 1. 데이터 신선도(Freshness) 모니터링

### 핵심 아이디어
각 데이터 소스마다 "예상 업데이트 주기"를 정의하고, 실제 업데이트 시간과 비교하여 지연을 감지.

### 구현 컨셉

```
┌─────────────────────────────────────────────────────────────┐
│  데이터 타입별 신선도 기준                                      │
├─────────────────┬────────────────┬──────────────────────────┤
│ 데이터 타입      │ 업데이트 주기    │ 허용 지연 임계값           │
├─────────────────┼────────────────┼──────────────────────────┤
│ AI Stock        │ 실시간 (장중)   │ 5분                       │
│ Commodity       │ 15분           │ 30분                      │
│ Forex           │ 10분           │ 20분                      │
│ Dividend        │ 1일 (장 마감후) │ 2일                       │
└─────────────────┴────────────────┴──────────────────────────┘
```

### 확장 아이디어

- **시장 시간 인지**: 장 마감 시간대에는 주식 데이터 업데이트 기대하지 않음
- **휴일 캘린더 연동**: 공휴일/비거래일 자동 제외
- **다중 임계값**: Warning (1.5x) → Critical (2x) → Alert (3x)
- **데이터 소스별 SLA 정의**: 업스트림 API의 공식 SLA 반영

### 시각화 아이디어

```
📊 신선도 타임라인 뷰
───────────────────────────────────────────────────────

AI Stock  [====■================] 마지막 3분 전 ✓
Commodity [======■==============] 마지막 8분 전 ✓
Forex     [================■====] 마지막 45분 전 ⚠️
Dividend  [=====================■] 마지막 26시간 전 🔴

■ = 마지막 업데이트 시점
```

---

## 2. 데이터 완전성(Completeness) 검증

### 핵심 아이디어
타겟 리스트의 모든 항목에 대해 실제 DB에 데이터가 존재하는지 검증.

### 검증 레이어

```
Layer 1: 존재성 (Existence)
├── 타겟 심볼이 DB에 존재하는가?
└── NULL 레코드 비율

Layer 2: 필드 완전성 (Field Completeness)
├── 필수 필드가 모두 채워져 있는가?
└── 필드별 NULL/빈값 비율

Layer 3: 관계 무결성 (Referential Integrity)
├── 연관 테이블 데이터 존재 여부
└── FK 참조 유효성
```

### 메트릭 정의

| 메트릭 | 설명 | 계산식 |
|--------|------|--------|
| Coverage Rate | 타겟 대비 데이터 존재 비율 | (실제 데이터 수 / 타겟 수) × 100 |
| Field Fill Rate | 필수 필드 채워진 비율 | (NULL 아닌 필드 / 전체 필수 필드) × 100 |
| Data Freshness Score | 신선도 점수 | 각 항목의 업데이트 시간 기반 가중 평균 |

### 누락 데이터 분석

```
📋 누락 패턴 분석
───────────────────────────────────────

반복 누락 심볼 (최근 7일):
1. INTEL - 5회 누락 (71%) ← 심볼 변경 의심
2. VND/KRW - 3회 누락 (43%) ← 소스 불안정
3. 정다운 - 2회 누락 (29%) ← 거래 정지?

누락 시간대 패턴:
- 09:00-10:00 집중 (장 시작 직후 API 부하)
- 15:30-16:00 집중 (장 마감 처리)
```

---

## 3. 이상치(Anomaly) 탐지

### 탐지 전략

```
┌─────────────────────────────────────────────────────────────┐
│                    다층 이상치 탐지                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐       │
│  │  통계적      │   │  도메인      │   │  패턴       │       │
│  │  이상치      │   │  규칙 기반   │   │  학습 기반  │       │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘       │
│         │                 │                 │              │
│  Z-Score > 3      가격 < 0 불가      계절성 벗어남          │
│  IQR 방식         환율 변동폭 제한   시계열 예측 편차        │
│  전일대비 %       배당률 범위       유사 종목 비교          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 도메인별 이상치 규칙

**AI Stock**
- 전일 대비 ±20% 이상 변동 → 주의
- 거래량 0 + 가격 변동 → 데이터 오류 의심
- 52주 신고가/신저가 ±5% → 확인 필요

**Commodity**
- 국제 기준가 대비 ±10% 이상 괴리
- 금/은 비율 역전 → 데이터 오류 의심
- WTI/Brent 스프레드 이상

**Forex**
- 일중 변동폭 ±3% 초과
- 기준환율 대비 매매율 스프레드 이상
- 관련 통화쌍 크로스레이트 불일치

**Dividend**
- 배당률 50% 초과 → 오류 가능성 높음
- 전분기 대비 배당률 2배 이상 변동
- 주가 대비 배당금 역산 검증

### 이상치 심각도 분류

```
🚨 이상치 심각도 매트릭스
───────────────────────────────────────

              낮은 신뢰도    높은 신뢰도
           ┌─────────────┬─────────────┐
 높은 영향 │   🟡 검토    │   🔴 긴급   │
           ├─────────────┼─────────────┤
 낮은 영향 │   🟢 참고    │   🟡 검토   │
           └─────────────┴─────────────┘

영향도 = 리포트에서의 가중치 × 사용자 노출 빈도
신뢰도 = 이상치 탐지 알고리즘 확신도
```

---

## 4. 심볼 건강도(Symbol Health) 모니터링

### 심볼 라이프사이클 추적

```
심볼 상태 머신
───────────────────────────────────────

  ┌──────────┐    상장     ┌──────────┐
  │  미등록   │ ─────────> │   정상    │
  └──────────┘            └────┬─────┘
                               │
            ┌──────────────────┼──────────────────┐
            ▼                  ▼                  ▼
      ┌──────────┐      ┌──────────┐      ┌──────────┐
      │ 심볼변경  │      │ 거래정지  │      │  합병    │
      └──────────┘      └──────────┘      └──────────┘
            │                  │                  │
            └──────────────────┼──────────────────┘
                               ▼
                        ┌──────────┐
                        │  상장폐지 │
                        └──────────┘
```

### 외부 소스 크로스체크

| 검증 소스 | 체크 항목 | 주기 |
|----------|----------|------|
| KRX 공시 | 상장폐지, 거래정지, 심볼변경 | 매일 |
| Yahoo Finance | 미국 주식 심볼 유효성 | 매시간 |
| 한국은행 | 환율 코드 유효성 | 매일 |
| 거래소 공시 | 배당 관련 공시 | 매일 |

### 심볼 이력 관리

```
📜 심볼 변경 이력
───────────────────────────────────────

INTEL (현재: 타겟리스트)
├── 2024-01-15: 심볼 변경 감지 → INTC
├── 2024-01-15: 자동 매핑 생성 INTEL → INTC
└── 2024-01-16: 관리자 확인 대기 중

권장 조치: 타겟 리스트에서 INTEL → INTC로 업데이트
```

---

## 5. 데이터 소스 건강 모니터링

### API 헬스체크 메트릭

```
┌─────────────────────────────────────────────────────────────┐
│  데이터 소스 건강 점수 (0-100)                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────────────────┐                                     │
│  │   Availability     │  가용성: API 응답 성공률             │
│  │   ████████░░ 85%   │                                     │
│  └────────────────────┘                                     │
│                                                             │
│  ┌────────────────────┐                                     │
│  │   Latency          │  응답시간: P95 기준                  │
│  │   ██████████ 95%   │  (< 500ms = 100%)                   │
│  └────────────────────┘                                     │
│                                                             │
│  ┌────────────────────┐                                     │
│  │   Data Quality     │  데이터 품질: 파싱 성공률            │
│  │   █████████░ 90%   │                                     │
│  └────────────────────┘                                     │
│                                                             │
│  종합 점수: 90/100 🟢                                        │
└─────────────────────────────────────────────────────────────┘
```

### 소스별 상세 추적

**추적 메트릭**
- 응답 시간 (avg, P50, P95, P99)
- 에러율 (4xx, 5xx, timeout)
- Rate Limit 소진율
- 데이터 파싱 실패율
- 스키마 변경 감지

**장애 패턴 학습**
```
🔮 장애 예측
───────────────────────────────────────

환율 API 장애 예측: 72% 확률 (다음 2시간 내)

근거:
- 응답시간 점진적 증가 (500ms → 1,200ms)
- 5xx 에러 빈도 증가 (0.1% → 2.3%)
- 과거 유사 패턴: 2024-12-15, 2025-01-08

권장 조치:
- 백업 소스 (한국은행 API) 대기 모드 전환
- 리포트 발행 지연 알림 준비
```

---

## 6. 프리플라이트 체크 (리포트 발행 전 검증)

### 체크리스트 프레임워크

```
🛫 리포트 발행 전 체크리스트
═══════════════════════════════════════════════════════

리포트: AI Stock Daily Report
발행 예정: 2025-01-26 09:00 KST
타겟: 37개 종목

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 데이터 신선도 검증
   [✓] 모든 데이터 24시간 이내 업데이트
   [✓] 장중 데이터 5분 이내 업데이트

2. 데이터 완전성 검증
   [✓] 37/37 종목 데이터 존재 (100%)
   [✓] 필수 필드 완전성 100%

3. 이상치 검증
   [!] 2건의 이상치 감지
       - NVDA: 전일대비 +15% (자동 승인됨 - 실제 시장 변동)
       - AMD: 거래량 급증 +300% (확인 필요)

4. 심볼 유효성
   [✓] 모든 심볼 유효

5. 데이터 소스 상태
   [✓] Yahoo Finance API 정상
   [✓] 백업 소스 대기 중

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

결과: ⚠️ 조건부 발행 가능

[AMD 이상치 무시하고 발행] [수동 검토 후 발행] [발행 보류]
```

### 자동 승인 규칙

```yaml
auto_approve_rules:
  anomaly:
    # 뉴스 기반 자동 승인
    - condition: "anomaly.type == 'price_change'"
      action: "approve"
      when: "news_api.has_relevant_news(symbol, 24h)"

    # 시장 전체 변동 시 자동 승인
    - condition: "anomaly.type == 'price_change'"
      action: "approve"
      when: "market_index.change > 2%"

    # 배당락일 자동 승인
    - condition: "anomaly.type == 'dividend_change'"
      action: "approve"
      when: "calendar.is_ex_dividend_date(symbol)"
```

### 발행 게이트 정책

```
발행 게이트
───────────────────────────────────────

Gate 1: 필수 통과 (blocking)
├── 데이터 완전성 ≥ 95%
├── 신선도 검증 통과
└── 데이터 소스 가용성 ≥ 1개

Gate 2: 권장 통과 (warning)
├── 이상치 0건 또는 모두 설명됨
├── 심볼 유효성 100%
└── 데이터 품질 점수 ≥ 90

Gate 3: 품질 등급 (grading)
├── A: 모든 체크 통과
├── B: Gate 1 통과, Gate 2 일부 경고
├── C: Gate 1 통과, Gate 2 다수 경고
└── F: Gate 1 실패 → 발행 차단
```

---

## 7. 히스토리컬 트렌드 분석

### 리포트 발행 성공률 추적

```
📈 월간 리포트 발행 현황
───────────────────────────────────────

2025년 1월 (현재까지)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

AI Stock     │████████████████████░░░░│ 20/26 (77%)
Commodity    │██████████████████████░░│ 22/26 (85%)
Forex        │███████████████░░░░░░░░░│ 15/26 (58%) ⚠️
Dividend     │█████████████████████░░░│ 21/26 (81%)

전체 성공률: 75% (목표: 95%)
```

### 실패 원인 분류

```
🔍 실패 원인 분석 (최근 30일)
───────────────────────────────────────

원인 카테고리:
├── 데이터 소스 장애    42% ████████░░
│   └── 환율 API 타임아웃 (28건)
│   └── Yahoo Finance 429 에러 (8건)
│
├── 데이터 품질 이슈    31% ██████░░░░
│   └── 필수 필드 누락 (15건)
│   └── 이상치 미해결 (12건)
│
├── 심볼 문제          18% ████░░░░░░
│   └── 심볼 변경 미반영 (9건)
│   └── 상장폐지 종목 (5건)
│
└── 시스템 오류         9% ██░░░░░░░░
    └── 메모리 부족 (4건)
    └── 타임아웃 (3건)
```

### 패턴 인사이트

```
💡 발견된 패턴
───────────────────────────────────────

1. 시간대 패턴
   - 월요일 오전: 환율 API 장애 빈도 3배 증가
   - 금요일 장 마감: 배당 데이터 지연 빈번

2. 계절성 패턴
   - 분기말: 배당 정보 변동 집중
   - 연초: 심볼 변경 집중 (결산 반영)

3. 상관관계
   - Yahoo Finance 에러 → 30분 후 KRX 데이터 지연
   - 환율 급변동 → 원자재 데이터 이상치 증가

권장 조치:
- 월요일 오전 리포트 발행 30분 지연
- 분기말 1주간 프리플라이트 체크 강화
```

---

## 8. 알림 및 에스컬레이션

### 알림 채널 매트릭스

```
알림 우선순위 매핑
───────────────────────────────────────

              Slack    Email   PagerDuty   Dashboard
           ┌─────────┬────────┬──────────┬───────────┐
 🔴 긴급    │   ✓     │   ✓    │    ✓     │    ✓      │
 🟡 경고    │   ✓     │   ✓    │    -     │    ✓      │
 🟢 정보    │   -     │   -    │    -     │    ✓      │
           └─────────┴────────┴──────────┴───────────┘
```

### 에스컬레이션 정책

```
에스컬레이션 타임라인
───────────────────────────────────────

T+0min   이슈 감지
         └── Dashboard 표시, Slack 알림

T+5min   1차 미확인
         └── 담당자 멘션 (@data-team)

T+15min  2차 미확인
         └── 팀장 이메일, Slack 스레드 생성

T+30min  3차 미확인
         └── PagerDuty 호출, 리포트 발행 자동 지연

T+60min  미해결
         └── 임원 에스컬레이션, 대체 데이터 소스 자동 전환
```

---

## 9. 대시보드 레이아웃 구상

### 메인 대시보드

```
┌─────────────────────────────────────────────────────────────────────┐
│  📊 리포트 데이터 품질 모니터링                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  실시간 상태 요약                                              │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐                 │  │
│  │  │ AI주식  │ │ 원자재  │ │  환율   │ │ 배당주  │                 │  │
│  │  │  🟢    │ │  🟢    │ │  🟡    │ │  🟢    │                 │  │
│  │  │ Ready  │ │ Ready  │ │ Warning│ │ Ready  │                 │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘                 │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌────────────────────────────┐ ┌────────────────────────────────┐ │
│  │  데이터 신선도 타임라인      │ │  이상치 알림 피드               │ │
│  │                            │ │                                │ │
│  │  AI Stock  [====■===] 3m   │ │  🟡 NVDA +15% (뉴스 확인됨)    │ │
│  │  Commodity [======■=] 8m   │ │  🟡 AMD 거래량 +300%           │ │
│  │  Forex     [=========■] 45m│ │  🔴 VND/KRW 데이터 누락        │ │
│  │  Dividend  [====■====] 2h  │ │                                │ │
│  └────────────────────────────┘ └────────────────────────────────┘ │
│                                                                     │
│  ┌────────────────────────────┐ ┌────────────────────────────────┐ │
│  │  데이터 소스 건강           │ │  다음 리포트 프리플라이트        │ │
│  │                            │ │                                │ │
│  │  Yahoo    🟢 120ms  0.1%   │ │  AI Stock 09:00 발행 예정      │ │
│  │  KRX      🟢 89ms   0.3%   │ │  ✓ 신선도  ✓ 완전성  ! 이상치  │ │
│  │  한국은행  🟡 2.1s   2.1%   │ │                                │ │
│  │  배당API  🔴 timeout 15%   │ │  [상세 보기] [수동 발행]        │ │
│  └────────────────────────────┘ └────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 상세 분석 뷰

```
📋 AI Stock 상세 분석
═══════════════════════════════════════════════════════════════════

필터: [전체 ▼] [오늘 ▼] [이상치만 ☐]

┌─────────┬────────────┬─────────┬─────────┬─────────┬──────────┐
│ Symbol  │ Display    │ 최종갱신 │  현재가  │ 전일대비 │  상태    │
├─────────┼────────────┼─────────┼─────────┼─────────┼──────────┤
│ AAPL    │ Apple      │ 2분 전  │ $185.50 │ +1.2%   │ 🟢 정상  │
│ GOOGL   │ Alphabet   │ 2분 전  │ $142.30 │ -0.5%   │ 🟢 정상  │
│ NVDA    │ NVIDIA     │ 2분 전  │ $890.00 │ +15.2%  │ 🟡 확인중 │
│ AMD     │ AMD        │ 2분 전  │ $178.90 │ +2.1%   │ 🟡 이상치 │
│ INTEL   │ Intel      │ - 없음 - │    -    │    -    │ 🔴 누락  │
└─────────┴────────────┴─────────┴─────────┴─────────┴──────────┘

[CSV 내보내기] [새로고침] [프리플라이트 실행]
```

---

## 10. 추가 아이디어 (미래 확장)

### ML 기반 품질 예측
- 과거 데이터 패턴 학습으로 장애 사전 예측
- 이상치 자동 분류 (실제 시장 변동 vs 데이터 오류)

### 자동 복구 메커니즘
- 백업 데이터 소스 자동 전환
- 캐시된 데이터로 임시 발행 (신선도 표시 포함)

### 크로스 리포트 검증
- 여러 리포트 간 데이터 일관성 체크
- 동일 종목의 다른 리포트 간 가격 불일치 감지

### 사용자 피드백 루프
- 리포트 수신자의 오류 리포트 수집
- 피드백 기반 이상치 탐지 규칙 개선

---

## 구현 우선순위 제안

| 우선순위 | 기능 | 이유 |
|---------|------|------|
| P0 | 프리플라이트 체크 | 발행 실패 즉시 차단 가능 |
| P0 | 데이터 완전성 검증 | 누락 데이터 즉시 감지 |
| P1 | 데이터 신선도 모니터링 | 지연 데이터 조기 경보 |
| P1 | 이상치 탐지 | 품질 이슈 사전 감지 |
| P2 | 데이터 소스 건강 | 장애 예측 및 대응 |
| P2 | 심볼 건강도 | 장기적 데이터 정합성 |
| P3 | 히스토리컬 분석 | 패턴 기반 개선 |
| P3 | ML 기반 예측 | 자동화 고도화 |

---

## 기술 스택 고려사항

### 기존 시스템 연계
- NestJS 백엔드에 모니터링 모듈 추가
- 기존 CacheService 활용 (신선도 추적)
- 기존 AnomalyDetectionService 확장 (이상치 탐지)
- Slack 알림 서비스 재사용

### 신규 필요 컴포넌트
- 타겟 리스트 관리 DB 테이블
- 데이터 소스 헬스체크 스케줄러
- 프리플라이트 체크 엔진
- 히스토리 저장소 (시계열 DB 또는 BigQuery)

---

## 11. 리뷰 및 보완사항

> 📅 리뷰 일자: 2026-01-26

### 🔴 주요 보완 필요사항

#### 11.1 실제 데이터 소스 연결 정보

```
[현재 미정의]
- 리포트 타겟 CSV 파일은 있으나, 실제 데이터 소스 명시 필요
- "서비스 DB"가 구체적으로 어떤 DB인지 확인 필요
- 기존 ETL 파이프라인과의 연계점 확인 필요

[확인 필요 항목]
┌─────────────┬─────────────────┬─────────────────┬─────────────────┐
│ 리포트 타입  │ 데이터 소스 DB   │ 테이블/API      │ ETL 주기        │
├─────────────┼─────────────────┼─────────────────┼─────────────────┤
│ AI Stock    │ (TBD)           │ (TBD)           │ (TBD)           │
│ Commodity   │ (TBD)           │ (TBD)           │ (TBD)           │
│ Forex       │ (TBD)           │ (TBD)           │ (TBD)           │
│ Dividend    │ (TBD)           │ (TBD)           │ (TBD)           │
└─────────────┴─────────────────┴─────────────────┴─────────────────┘
```

#### 11.2 리포트 스케줄 정보

```
[확인 필요]
┌─────────────┬─────────────┬─────────────────┬─────────────────┐
│ 리포트 타입  │ 발행 시간    │ 프리플라이트    │ 데이터 마감     │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│ AI Stock    │ (TBD)       │ 발행 10분 전    │ 발행 15분 전    │
│ Commodity   │ (TBD)       │ 발행 10분 전    │ 발행 15분 전    │
│ Forex       │ (TBD)       │ 발행 10분 전    │ 발행 15분 전    │
│ Dividend    │ (TBD)       │ 발행 10분 전    │ 발행 15분 전    │
└─────────────┴─────────────┴─────────────────┴─────────────────┘
```

#### 11.3 타겟 리스트 관리 전략

```
[결정 필요]
현재: CSV 파일 기반 (docs/guides/target_*.csv)
옵션 A: CSV 유지 + Git 버전 관리
옵션 B: DB 테이블 마이그레이션 + audit log

[타겟 리스트 변경 워크플로우 - TBD]
1. 변경 요청 → 2. 검토 → 3. 적용 → 4. 검증
```

### 🟡 개선 제안사항

#### 11.4 시간대(Timezone) 처리

```
규칙:
- 모든 timestamp는 UTC로 저장
- 표시는 KST (UTC+9) 기준
- 미국 주식: EST/EDT 장 시간 고려
- 원자재: 24시간 글로벌 마켓
```

#### 11.5 API 엔드포인트 설계 (안)

```
[Report Monitoring API]
GET  /api/report-monitoring/status                    # 전체 상태 요약
GET  /api/report-monitoring/status/{reportType}       # 특정 리포트 상태
POST /api/report-monitoring/preflight/{reportType}    # 프리플라이트 실행
GET  /api/report-monitoring/preflight/{id}            # 프리플라이트 결과 조회
GET  /api/report-monitoring/anomalies                 # 이상치 목록
POST /api/report-monitoring/anomalies/{id}/approve    # 이상치 승인
GET  /api/report-monitoring/sources/health            # 데이터 소스 건강
GET  /api/report-monitoring/history                   # 히스토리 조회
```

#### 11.6 알림 메시지 템플릿

**Slack 알림 (긴급)**
```
🔴 *리포트 발행 차단*
━━━━━━━━━━━━━━━━━━━━━━
• 리포트: {reportType}
• 예정 시간: {scheduledTime}
• 사유: {reason}
• 누락 항목: {missingItems}
━━━━━━━━━━━━━━━━━━━━━━
<{preflightUrl}|프리플라이트 상세 보기>
```

**Slack 알림 (경고)**
```
🟡 *이상치 감지*
• 리포트: {reportType}
• 항목: {symbol} ({displayName})
• 내용: {anomalyDescription}
• 조치: {suggestedAction}
```

#### 11.7 권한/접근 제어

```
[역할 정의]
┌──────────┬───────────┬─────────────────┬────────────┐
│ 역할      │ 대시보드   │ 프리플라이트 승인 │ 설정 변경  │
├──────────┼───────────┼─────────────────┼────────────┤
│ Viewer   │ ✓ 읽기    │ -               │ -          │
│ Operator │ ✓ 읽기    │ ✓               │ -          │
│ Admin    │ ✓ 읽기    │ ✓               │ ✓          │
└──────────┴───────────┴─────────────────┴────────────┘
```

#### 11.8 테스트 전략

```
[단위 테스트]
- 완전성 검증 로직
- 이상치 탐지 규칙 (각 도메인별)
- 신선도 계산 로직

[통합 테스트]
- 프리플라이트 체크 전체 흐름
- 알림 발송 (mock)

[E2E 테스트]
- 대시보드 → API → DB 전체 흐름
```

#### 11.9 용어집

| 용어 | 정의 | 예시 |
|------|------|------|
| symbol | 종목/상품 식별자 | AAPL, GCUSD, 352090 |
| item_code | 환율 식별자 | 0000001 (USD/KRW) |
| display_name | 사용자 표시명 | Apple, 금 (Gold) |
| 타겟 리스트 | 리포트에 포함될 항목 목록 | target_ai_stock.csv |
| 프리플라이트 | 리포트 발행 전 품질 검증 | - |

#### 11.10 CSV 파일 수정 필요사항

```
[target_ai_stock.csv]
- INTEL → INTC로 수정 필요 (잘못된 심볼)

[이상치 규칙 조정]
- 배당률 임계값: 50% → 30%로 조정 검토
  (한샘 19.06%, 레드캡투어 19.46% 등 고배당주 존재)
```

---

## 12. MVP (최소 구현 범위)

> 핵심 목표: **리포트 발행 전 데이터 문제를 감지하여 발행 실패 방지**

### MVP 범위 정의

```
┌─────────────────────────────────────────────────────────────┐
│                     MVP 포함 기능                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ 포함                          ❌ 제외 (추후 구현)        │
│  ─────────────────────────────    ─────────────────────────│
│  • 데이터 완전성 검증              • ML 기반 예측            │
│  • 기본 이상치 탐지 (Z-Score)      • 장애 패턴 학습          │
│  • 프리플라이트 체크               • 자동 복구 메커니즘      │
│  • 기본 대시보드 (상태 요약)       • 히스토리컬 트렌드 분석  │
│  • Slack 알림 (긴급/경고)         • 크로스 리포트 검증      │
│                                   • 사용자 피드백 루프      │
│                                   • 심볼 건강도 자동 추적   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### MVP 기능 상세

#### 12.1 데이터 완전성 검증

```typescript
// 핵심 기능
interface CompletenessCheck {
  reportType: 'ai_stock' | 'commodity' | 'forex' | 'dividend';
  targetCount: number;      // 타겟 리스트 항목 수
  actualCount: number;      // 실제 데이터 존재 수
  coverageRate: number;     // 커버리지 비율 (%)
  missingSymbols: string[]; // 누락된 심볼 목록
  nullFields: FieldCheck[]; // NULL 필드 체크
}

// 임계값
const THRESHOLDS = {
  COVERAGE_MIN: 95,        // 최소 커버리지 95%
  FIELD_FILL_MIN: 100,     // 필수 필드는 100% 채워져야 함
};
```

#### 12.2 기본 이상치 탐지

```typescript
// MVP에서는 간단한 규칙 기반만 구현
interface AnomalyRule {
  type: 'price_change' | 'volume_spike' | 'yield_outlier';
  threshold: number;
  severity: 'info' | 'warning' | 'critical';
}

const MVP_RULES: Record<string, AnomalyRule[]> = {
  ai_stock: [
    { type: 'price_change', threshold: 20, severity: 'warning' },  // ±20%
  ],
  commodity: [
    { type: 'price_change', threshold: 10, severity: 'warning' },  // ±10%
  ],
  forex: [
    { type: 'price_change', threshold: 3, severity: 'warning' },   // ±3%
  ],
  dividend: [
    { type: 'yield_outlier', threshold: 30, severity: 'warning' }, // >30%
  ],
};
```

#### 12.3 프리플라이트 체크

```typescript
interface PreflightResult {
  reportType: string;
  timestamp: Date;
  status: 'pass' | 'warning' | 'fail';

  checks: {
    completeness: { pass: boolean; details: CompletenessCheck };
    anomalies: { pass: boolean; items: AnomalyItem[] };
  };

  canPublish: boolean;       // 발행 가능 여부
  requiresApproval: boolean; // 수동 승인 필요 여부
}
```

#### 12.4 MVP API 엔드포인트

```
[MVP API - 최소 3개]
GET  /api/report-monitoring/status           # 전체 상태
POST /api/report-monitoring/preflight/{type} # 프리플라이트 실행
GET  /api/report-monitoring/preflight/{id}   # 결과 조회
```

#### 12.5 MVP 대시보드

```
┌─────────────────────────────────────────────────────────────┐
│  📊 리포트 데이터 품질 모니터링 (MVP)                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  리포트 상태                                            │ │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐          │ │
│  │  │ AI주식  │ │ 원자재  │ │  환율   │ │ 배당주  │          │ │
│  │  │  🟢    │ │  🟢    │ │  🟡    │ │  🟢    │          │ │
│  │  │ 37/37  │ │  4/4   │ │  7/8   │ │ 50/50  │          │ │
│  │  └────────┘ └────────┘ └────────┘ └────────┘          │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  최근 이상치                                            │ │
│  │  • 🟡 VND/KRW 데이터 누락 (환율)                        │ │
│  │  • 🟡 NVDA +15.2% 변동 (AI주식)                        │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                             │
│  [프리플라이트 실행 ▼]                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 12.6 MVP Slack 알림

```
[발행 차단 시]
🔴 *리포트 발행 차단*
• 리포트: AI Stock
• 사유: 데이터 완전성 미달 (92%)
• 누락: INTEL, SWKS

[이상치 감지 시]
🟡 *이상치 감지*
• 리포트: Forex
• 항목: VND/KRW
• 내용: 데이터 누락
```

### MVP 구현 순서

```
Phase 1: 백엔드 기반 (1주)
├── 1-1. 타겟 리스트 로더 (CSV 파싱)
├── 1-2. 완전성 검증 서비스
├── 1-3. 이상치 탐지 서비스 (기본 규칙)
└── 1-4. 프리플라이트 체크 서비스

Phase 2: API & 알림 (0.5주)
├── 2-1. REST API 엔드포인트 (3개)
└── 2-2. Slack 알림 연동

Phase 3: 프론트엔드 (0.5주)
├── 3-1. 상태 요약 대시보드
└── 3-2. 프리플라이트 실행 버튼
```

### MVP 제외 사항 (향후 로드맵)

| Phase | 기능 | 예상 시점 |
|-------|------|----------|
| v1.1 | 데이터 신선도 모니터링 | MVP 후 1주 |
| v1.2 | 데이터 소스 건강 모니터링 | MVP 후 2주 |
| v1.3 | 히스토리컬 트렌드 분석 | MVP 후 1개월 |
| v2.0 | ML 기반 이상치 분류 | 미정 |

---

## 13. 다음 단계

### 구현 전 확인 필요사항

- [ ] 실제 데이터 소스 DB/테이블 정보 확인
- [ ] 리포트 발행 스케줄 확인
- [ ] 리포트 발행 시스템과의 연동 방식 결정
- [ ] 타겟 리스트 관리 방식 결정 (CSV 유지 vs DB 마이그레이션)

### 준비 완료 시 시작 가능

- [x] MVP 범위 정의
- [x] 핵심 데이터 구조 정의
- [x] API 엔드포인트 설계
- [x] 대시보드 와이어프레임
