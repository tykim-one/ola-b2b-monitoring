# Missing(누락) 데이터 상세 정보 추가 계획

> 현재 누락 데이터는 심볼만 표시됩니다. 운영자가 빠르게 원인을 파악하고 조치할 수 있도록 상세 정보를 추가합니다.

---

## 1. 현재 상태 vs 목표

### 1.1 현재 (Before)

```
🔴 누락 (3건)
┌─────────────────────────────────┐
│ AAPL, TSLA, NVDA                │  ← 심볼만 표시
└─────────────────────────────────┘
```

### 1.2 목표 (After)

```
🔴 누락 (3건)
┌──────────────────────────────────────────────────────────────────────┐
│ 심볼      │ 종목명           │ 원인        │ 마지막 존재    │ 누락 기간 │
├──────────────────────────────────────────────────────────────────────┤
│ AAPL     │ Apple Inc.       │ ETL 실패    │ 2025-01-25    │ 2일      │
│ TSLA     │ Tesla Inc.       │ 신규 종목   │ -             │ -        │
│ NVDA     │ NVIDIA Corp.     │ 삭제됨      │ 2025-01-20    │ 7일      │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 2. 추가할 상세 정보

| 항목 | 설명 | 데이터 소스 |
|------|------|-------------|
| **표시명 (displayName)** | 종목의 한글/영문 이름 | `gold.target_*` 테이블의 `display_name` |
| **마지막 존재 시점 (lastSeenAt)** | 과거에 데이터가 있었던 마지막 날짜 | `gold.daily_item_info` 히스토리 조회 |
| **누락 기간 (daysMissing)** | 마지막 존재 시점부터 오늘까지 일수 | 계산: `오늘 - lastSeenAt` |
| **누락 원인 (missingReason)** | 신규/삭제/ETL 실패 분류 | 로직 기반 판정 |

---

## 3. 누락 원인 분류 로직

### 3.1 분류 기준

| 원인 | 조건 | 설명 |
|------|------|------|
| **신규 종목 (NEW)** | 히스토리에 데이터가 한 번도 없음 | 타겟에 추가되었지만 아직 ETL이 안 돌았거나 데이터 소스에 없음 |
| **ETL 실패 (ETL_FAILED)** | 최근 7일 내 데이터가 있었음 | 데이터가 있다가 갑자기 없어짐 → ETL 파이프라인 이슈 의심 |
| **삭제/중단 (DISCONTINUED)** | 7일 이상 전에 마지막 데이터 | 의도적으로 삭제되었거나 데이터 소스에서 중단됨 |
| **알 수 없음 (UNKNOWN)** | 위 조건에 해당하지 않음 | 수동 확인 필요 |

### 3.2 판정 플로우차트

```
                    히스토리에 데이터 있음?
                           │
              ┌────────────┴────────────┐
              │                         │
             NO                        YES
              │                         │
              ▼                         ▼
         🆕 NEW                  마지막 존재가 7일 이내?
      (신규 종목)                       │
                           ┌───────────┴───────────┐
                           │                       │
                          YES                     NO
                           │                       │
                           ▼                       ▼
                    ⚠️ ETL_FAILED           📦 DISCONTINUED
                   (ETL 실패 의심)           (삭제/중단됨)
```

---

## 4. 데이터 구조 변경

### 4.1 인터페이스 추가

```typescript
// interfaces/report-target.interface.ts

/**
 * 누락 원인 타입
 */
export type MissingReason = 'NEW' | 'ETL_FAILED' | 'DISCONTINUED' | 'UNKNOWN';

/**
 * 누락 데이터 상세 정보
 */
export interface MissingDetail {
  symbol: string;
  displayName: string;        // 타겟 테이블의 display_name
  lastSeenAt: Date | null;    // 마지막으로 데이터가 있었던 날짜 (없으면 null)
  daysMissing: number | null; // 누락 기간 (일)
  missingReason: MissingReason; // 누락 원인
}
```

### 4.2 ReportCheckResult 확장

```typescript
export interface ReportCheckResult {
  // 기존 필드...
  missingSymbols: string[];

  // 새 필드
  missingDetails: MissingDetail[];  // 누락 상세 정보
}
```

### 4.3 MonitoringSummary 확장 (선택)

```typescript
export interface MonitoringSummary {
  // 기존 필드...
  totalMissing: number;

  // 새 필드 (원인별 집계)
  missingByReason: {
    new: number;
    etlFailed: number;
    discontinued: number;
    unknown: number;
  };
}
```

---

## 5. SQL 쿼리 설계

### 5.1 마지막 존재 시점 조회

```sql
-- PostgreSQL: 누락된 심볼들의 마지막 존재 시점 조회
SELECT
  symbol,
  MAX(updated_at) as last_seen_at
FROM gold.daily_item_info
WHERE symbol IN ($1, $2, $3, ...)  -- 누락된 심볼 목록
GROUP BY symbol;
```

### 5.2 결과 예시

| symbol | last_seen_at |
|--------|--------------|
| AAPL | 2025-01-25 |
| NVDA | 2025-01-20 |
| (TSLA는 결과 없음 → 신규 종목) |

---

## 6. 구현 단계

### Phase 1: 백엔드 수정

| 단계 | 파일 | 작업 |
|------|------|------|
| 1 | `interfaces/report-target.interface.ts` | `MissingDetail`, `MissingReason` 타입 추가 |
| 2 | `external-db.service.ts` | `getMissingDetails()` 메서드 추가 |
| 3 | `report-monitoring.service.ts` | `checkReport()`에서 누락 상세 조회 로직 추가 |
| 4 | `dto/monitoring-result.dto.ts` | DTO 업데이트 |

### Phase 2: 프론트엔드 수정

| 단계 | 파일 | 작업 |
|------|------|------|
| 5 | `reportMonitoringService.ts` | 타입 추가 |
| 6 | `page.tsx` | 누락 상세 테이블 UI 구현 |

### Phase 3: 문서 업데이트

| 단계 | 파일 | 작업 |
|------|------|------|
| 7 | `report-monitoring-guide.md` | 누락 원인 분류 설명 추가 |

---

## 7. UI 디자인

### 7.1 이슈 상세 섹션 (확장)

```
🔴 누락 (3건) - 데이터 없음
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ 🆕 신규 종목 (1건) - 타겟에 추가되었으나 데이터 미수집              │ │
│  │ ┌───────────────────────────────────────────────────────────────┐  │ │
│  │ │ TSLA │ Tesla Inc. │ 신규 │ - │ - │                            │  │ │
│  │ └───────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ ⚠️ ETL 실패 의심 (1건) - 최근 데이터가 있다가 사라짐               │ │
│  │ ┌───────────────────────────────────────────────────────────────┐  │ │
│  │ │ AAPL │ Apple Inc. │ ETL 실패 │ 01-25 │ 2일 전 │              │  │ │
│  │ └───────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ 📦 삭제/중단 (1건) - 7일 이상 데이터 없음                          │ │
│  │ ┌───────────────────────────────────────────────────────────────┐  │ │
│  │ │ NVDA │ NVIDIA Corp. │ 삭제됨 │ 01-20 │ 7일 전 │              │  │ │
│  │ └───────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 7.2 색상 코드

| 원인 | 배경색 | 텍스트색 | 아이콘 |
|------|--------|----------|--------|
| 신규 (NEW) | `bg-blue-900/30` | `text-blue-400` | 🆕 |
| ETL 실패 (ETL_FAILED) | `bg-rose-900/30` | `text-rose-400` | ⚠️ |
| 삭제됨 (DISCONTINUED) | `bg-slate-800/50` | `text-slate-400` | 📦 |
| 알 수 없음 (UNKNOWN) | `bg-amber-900/30` | `text-amber-400` | ❓ |

---

## 8. 추가 고려사항

### 8.1 성능

- **히스토리 조회 최적화**: 누락된 심볼이 많을 경우 배치 쿼리로 처리
- **인덱스**: `gold.daily_item_info`의 `(symbol, updated_at)` 복합 인덱스 권장

### 8.2 캐싱

- 마지막 존재 시점은 자주 변하지 않으므로 **SHORT 캐시 (5분)** 적용 가능

### 8.3 Slack 알림 개선

```
🔴 리포트 데이터 이슈 감지: AI 주식

누락 데이터 (3건):
• 🆕 신규: TSLA (Tesla Inc.)
• ⚠️ ETL 실패: AAPL (Apple Inc.) - 2일 전까지 정상
• 📦 삭제됨: NVDA (NVIDIA Corp.) - 7일 전부터 누락

조치 필요:
- ETL 실패 건은 파이프라인 로그 확인 필요
- 신규 건은 데이터 소스 확인 필요
```

---

## 9. 예상 작업량

| Phase | 예상 시간 | 복잡도 |
|-------|----------|--------|
| Phase 1 (백엔드) | 1-2시간 | 중 |
| Phase 2 (프론트엔드) | 1시간 | 중 |
| Phase 3 (문서) | 30분 | 하 |
| **총계** | **2.5-3.5시간** | |

---

## 10. 검증 체크리스트

- [ ] 신규 종목이 "NEW"로 분류되는가?
- [ ] 최근 데이터가 있다가 사라진 경우 "ETL_FAILED"로 분류되는가?
- [ ] 7일 이상 누락된 경우 "DISCONTINUED"로 분류되는가?
- [ ] 타겟 테이블의 display_name이 정상 표시되는가?
- [ ] 마지막 존재 시점과 누락 기간이 정확히 계산되는가?
- [ ] Slack 알림에 상세 정보가 포함되는가?
- [ ] 대시보드 UI에서 원인별로 그룹핑되어 표시되는가?

---

*작성일: 2025-01-27*
