# 리포트 데이터 모니터링 검증 가이드

> 이 문서는 리포트 모니터링 대시보드의 데이터 검증 로직을 비개발자도 이해할 수 있도록 설명합니다.

---

## 1. 개요: 모니터링이 하는 일

리포트 모니터링 시스템은 **"우리가 제공해야 할 데이터가 제대로 있는가?"**를 매일 확인합니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      모니터링 검증 흐름                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1️⃣ 타겟 목록 로드        2️⃣ 존재 여부 확인      3️⃣ 신선도 확인   │
│   ─────────────────      ─────────────────     ─────────────── │
│                                                                 │
│   "검증해야 할 항목은     "DB에 데이터가        "데이터가 오늘    │
│    무엇인가?"             있는가?"              업데이트 됐는가?" │
│                                                                 │
│   gold.target_ai_stock    gold.daily_item_info                  │
│   gold.target_commodity       ↓                                 │
│   gold.target_forex       symbol 컬럼 비교     updated_at 비교   │
│   gold.target_dividend                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 검증 대상: 4종 리포트

| 리포트 타입 | 설명 | 타겟 테이블 | 예시 심볼 |
|-------------|------|-------------|-----------|
| **AI Stock** | AI 기반 주식 분석 리포트 | `gold.target_ai_stock` | AAPL, TSLA, NVDA |
| **Commodity** | 원자재 시세 리포트 | `gold.target_commodity` | GOLD, SILVER, OIL |
| **Forex** | 환율 리포트 | `gold.target_forex` | USD/KRW, EUR/USD |
| **Dividend** | 배당주 리포트 | `gold.target_dividend` | KO, JNJ, PG |

---

## 3. 검증 단계별 상세 설명

### 3.1 단계 1: 타겟 목록 로드 (무엇을 검증할 것인가?)

**목적**: 검증해야 할 심볼(종목 코드) 목록을 가져옵니다.

**데이터 소스**:
- 각 리포트 타입별로 `gold.target_{타입}` 테이블이 있습니다.
- 예: AI Stock 리포트 → `gold.target_ai_stock` 테이블

**타겟 테이블 구조 예시**:
| symbol | display_name |
|--------|--------------|
| AAPL | Apple Inc. |
| TSLA | Tesla Inc. |
| NVDA | NVIDIA Corp. |

> 💡 **타겟 테이블에 있는 심볼만 검증합니다.** 타겟 테이블에 없는 심볼은 검증 대상이 아닙니다.

---

### 3.2 단계 2: 존재 여부 확인 (데이터가 있는가?)

**목적**: 타겟 목록의 각 심볼이 실제 데이터 테이블에 존재하는지 확인합니다.

**검증 방법**:
```
타겟 테이블의 심볼 → gold.daily_item_info 테이블에서 검색
```

**비교 로직**:
```
┌────────────────────────────────────────────────────────────────┐
│  타겟 테이블                    데이터 테이블                    │
│  (gold.target_ai_stock)        (gold.daily_item_info)          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  AAPL  ────────────────────→   AAPL  ✅ 존재                   │
│  TSLA  ────────────────────→   TSLA  ✅ 존재                   │
│  NVDA  ────────────────────→   (없음) ❌ 누락                   │
│  AMZN  ────────────────────→   AMZN  ✅ 존재                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**판정 기준**:
| 상태 | 조건 | 의미 |
|------|------|------|
| ✅ **존재 (Existing)** | 타겟 심볼이 데이터 테이블에 있음 | 정상 |
| ❌ **누락 (Missing)** | 타겟 심볼이 데이터 테이블에 없음 | **심각한 문제** - 리포트 생성 불가 |

> ⚠️ **누락된 데이터가 있으면 Slack 알림이 발송됩니다.**

---

### 3.3 단계 3: 신선도 확인 (데이터가 최신인가?)

**목적**: 데이터가 존재하더라도, 최신 데이터인지 확인합니다.

**검증 방법**:
- 데이터 테이블의 `updated_at` 컬럼을 확인합니다.
- **오늘 날짜와 비교**하여 신선도를 판정합니다.

**비교 로직**:
```
┌────────────────────────────────────────────────────────────────┐
│                        신선도 판정 기준                          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  오늘: 2025년 1월 26일                                          │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 심볼    │ updated_at      │ 판정      │ 지연 일수        │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │ AAPL   │ 2025-01-26      │ ✅ 신선    │ 0일             │  │
│  │ TSLA   │ 2025-01-25      │ ⚠️ 오래됨  │ 1일             │  │
│  │ AMZN   │ 2025-01-23      │ ⚠️ 오래됨  │ 3일             │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**판정 기준**:
| 상태 | 조건 | 의미 |
|------|------|------|
| ✅ **신선 (Fresh)** | `updated_at` = 오늘 | 정상 - 최신 데이터 |
| ⚠️ **오래됨 (Stale)** | `updated_at` < 오늘 | **경고** - 어제 이전 데이터 |

> ⚠️ **오래된 데이터가 있으면 Slack 알림이 발송됩니다.**

---

## 4. 최종 판정 결과

### 4.1 단일 리포트 결과

각 리포트(AI Stock, Commodity 등)에 대해 다음 정보가 생성됩니다:

| 지표 | 설명 |
|------|------|
| **전체 타겟** | 검증해야 할 심볼 총 개수 |
| **존재 개수** | 데이터 테이블에 존재하는 심볼 수 |
| **누락 심볼** | 데이터가 없는 심볼 목록 |
| **신선 개수** | 오늘 업데이트된 심볼 수 |
| **오래된 심볼** | 어제 이전에 업데이트된 심볼 목록 |
| **중요 이슈 여부** | 누락 또는 오래된 데이터가 있으면 true |

### 4.2 이슈 판정 기준

```
┌─────────────────────────────────────────────────────────────────┐
│                        이슈 판정 로직                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   hasCriticalIssues = true  조건:                               │
│                                                                 │
│     누락된 심볼이 1개 이상 있거나 (missing > 0)                   │
│                   OR                                            │
│     오래된 심볼이 1개 이상 있을 때 (stale > 0)                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 전체 요약

모든 리포트의 결과를 종합한 요약이 생성됩니다:

| 지표 | 설명 |
|------|------|
| **전체 리포트 수** | 검증한 리포트 타입 수 (보통 4개) |
| **정상 리포트 수** | 이슈가 없는 리포트 수 |
| **이슈 리포트 수** | 이슈가 있는 리포트 수 |
| **전체 누락 수** | 모든 리포트의 누락 심볼 합계 |
| **전체 오래됨 수** | 모든 리포트의 오래된 심볼 합계 |

---

## 5. 상태 표시 (대시보드)

### 5.1 서비스 헬스 상태

| 상태 | 조건 | 의미 |
|------|------|------|
| 🟢 **Healthy** | DB 연결 정상 + 모든 타겟 테이블 존재 | 모든 것이 정상 |
| 🟡 **Degraded** | DB 연결 정상 + 일부 타겟 테이블 없음 | 일부 기능 제한 |
| 🔴 **Unhealthy** | DB 연결 실패 | 서비스 사용 불가 |

### 5.2 대시보드 카드 색상

| 색상 | 의미 |
|------|------|
| 🟢 초록색 배경 | 해당 리포트에 이슈 없음 |
| 🔴 빨간색 배경 | 해당 리포트에 누락 또는 오래된 데이터 있음 |

---

## 6. 알림 (Slack)

### 6.1 알림 발송 조건

- **누락 데이터 발견 시**: `critical` 레벨 알림
- **오래된 데이터만 있을 시**: `warning` 레벨 알림

### 6.2 알림 내용 예시

```
🚨 리포트 데이터 이슈 감지: AI 주식

다음 이슈가 발견되었습니다:
• 3개 데이터 누락
• 2개 데이터 오래됨 (어제 이전)

리포트 타입: AI 주식
전체 타겟: 50개
누락 데이터: NVDA, META, AMD
오래된 데이터: TSLA(1일 전), AMZN(3일 전)
체크 시간: 2025-01-26T08:00:00Z
```

---

## 7. 자동 실행 스케줄

| 설정 | 기본값 | 설명 |
|------|--------|------|
| 실행 시간 | 매일 08:00 | 한국 시간 기준 |
| 시간대 | Asia/Seoul | 환경변수로 변경 가능 |
| Cron 표현식 | `0 8 * * *` | 환경변수 `REPORT_MONITOR_CRON`으로 변경 가능 |

---

## 8. 용어 정리

| 용어 | 영문 | 설명 |
|------|------|------|
| 심볼 | Symbol | 종목 코드 (예: AAPL, TSLA) |
| 타겟 | Target | 검증해야 할 심볼 목록 |
| 신선 | Fresh | 오늘 업데이트된 데이터 |
| 오래됨 | Stale | 어제 이전에 업데이트된 데이터 |
| 누락 | Missing | 데이터 테이블에 존재하지 않는 심볼 |
| 지연 일수 | Days Behind | 마지막 업데이트로부터 경과한 일수 |

---

## 9. FAQ

### Q1: "누락"과 "오래됨"의 차이는?

- **누락 (Missing)**: 데이터 자체가 없음. 리포트를 생성할 수 없는 상태.
- **오래됨 (Stale)**: 데이터는 있지만 오늘 업데이트되지 않음. 어제 기준 데이터로 리포트 생성 가능하나, 최신 정보가 아님.

### Q2: 왜 어제 이전이면 "오래됨"으로 판정하나요?

리포트 데이터는 매일 업데이트되어야 합니다. `updated_at`이 오늘이 아니면, 데이터 파이프라인에 문제가 있을 수 있습니다.

### Q3: 타겟 테이블은 어떻게 관리되나요?

`gold.target_{리포트타입}` 테이블에 심볼이 등록되어 있어야 검증 대상이 됩니다. 새 종목을 추가하려면 해당 테이블에 레코드를 추가하면 됩니다.

### Q4: 수동으로 체크를 실행할 수 있나요?

대시보드의 "체크 실행" 버튼을 클릭하면 즉시 전체 검증이 실행됩니다.

---

## 10. 데이터 흐름 요약도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          리포트 모니터링 데이터 흐름                       │
└─────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────┐
  │  타겟 테이블      │
  │  (검증 대상 목록)  │
  │                  │
  │ gold.target_*    │
  │ - ai_stock       │
  │ - commodity      │
  │ - forex          │
  │ - dividend       │
  └────────┬─────────┘
           │
           │ 1️⃣ 심볼 목록 로드
           ▼
  ┌──────────────────┐
  │  모니터링 서비스   │
  │                  │
  │ - 존재 여부 체크   │
  │ - 신선도 체크     │
  │ - 결과 집계       │
  └────────┬─────────┘
           │
           │ 2️⃣ 심볼별 데이터 확인
           ▼
  ┌──────────────────┐        ┌──────────────────┐
  │  데이터 테이블     │        │  알림 서비스      │
  │                  │        │                  │
  │ gold.            │   3️⃣   │  Slack 웹훅      │
  │ daily_item_info  │───────→│  - 누락 알림      │
  │                  │ 이슈시  │  - 오래됨 알림    │
  │ - symbol         │        │                  │
  │ - updated_at     │        │                  │
  └──────────────────┘        └──────────────────┘
           │
           │ 4️⃣ 결과 캐싱
           ▼
  ┌──────────────────┐
  │  대시보드         │
  │                  │
  │ - KPI 카드       │
  │ - 리포트별 상세   │
  │ - 이슈 목록      │
  │ - 헬스 상태      │
  └──────────────────┘
```

---

*최종 업데이트: 2025-01-26*
