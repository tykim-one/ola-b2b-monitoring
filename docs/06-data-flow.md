# 데이터 흐름도

시스템 내에서 데이터가 어떻게 이동하고 처리되는지 설명합니다.

---

## 1. 전체 데이터 흐름 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              데이터 흐름 전체도                               │
└─────────────────────────────────────────────────────────────────────────────┘

[B2B 고객사 서비스]                                [OLA B2B Monitoring]
       │                                                    │
       │ 1. AI 챗봇 사용                                     │
       ▼                                                    │
┌─────────────┐                                             │
│  AI 챗봇    │──── 대화 로그 ────┐                          │
│  (Gemini)   │                  │                          │
└─────────────┘                  ▼                          │
                         ┌─────────────┐                    │
                         │  BigQuery   │◄───────────────────┤ 2. 로그 조회
                         │ (로그 저장) │                     │
                         └─────────────┘                    │
                                │                           │
                                │ 3. 쿼리 결과               │
                                ▼                           ▼
                         ┌─────────────────────────────────────┐
                         │           백엔드 (NestJS)           │
                         │  • 데이터 가공                       │
                         │  • 캐싱 (5분~1시간)                  │
                         │  • 이상 탐지                         │
                         │  • 배치 분석 실행                    │
                         └─────────────────────────────────────┘
                                │           │
                     4. REST API│           │5. AI 분석 요청
                                ▼           ▼
┌────────────────────┐   ┌─────────────┐   ┌─────────────┐
│ 프론트엔드 (Next.js)│   │   SQLite    │   │   Gemini    │
│  • 대시보드 표시    │   │ (관리 DB)   │   │  (AI 분석)  │
│  • 사용자 인터랙션  │   └─────────────┘   └─────────────┘
└────────────────────┘
```

---

## 2. 메트릭 조회 흐름

사용자가 대시보드에서 KPI를 조회할 때의 데이터 흐름입니다.

### 흐름도

```
사용자                프론트엔드              백엔드                   BigQuery
  │                      │                    │                        │
  │  1. 대시보드 접속     │                    │                        │
  │─────────────────────>│                    │                        │
  │                      │                    │                        │
  │                      │ 2. GET /api/metrics/realtime               │
  │                      │───────────────────>│                        │
  │                      │                    │                        │
  │                      │                    │ 3. 캐시 확인            │
  │                      │                    │──┐                     │
  │                      │                    │  │ 캐시 있음?          │
  │                      │                    │<─┘                     │
  │                      │                    │                        │
  │                      │                    │ 4. 캐시 없으면 쿼리     │
  │                      │                    │───────────────────────>│
  │                      │                    │                        │
  │                      │                    │ 5. 쿼리 결과 반환       │
  │                      │                    │<───────────────────────│
  │                      │                    │                        │
  │                      │                    │ 6. 캐시 저장 (5분)      │
  │                      │                    │──┐                     │
  │                      │                    │<─┘                     │
  │                      │                    │                        │
  │                      │ 7. JSON 응답       │                        │
  │                      │<───────────────────│                        │
  │                      │                    │                        │
  │  8. 차트/KPI 표시    │                    │                        │
  │<─────────────────────│                    │                        │
```

### 단계별 설명

| 단계 | 설명 |
|------|------|
| 1 | 사용자가 웹 브라우저로 대시보드 접속 |
| 2 | 프론트엔드가 백엔드 API 호출 |
| 3 | 백엔드가 캐시에서 데이터 확인 |
| 4 | 캐시가 없거나 만료됐으면 BigQuery 쿼리 |
| 5 | BigQuery가 집계된 결과 반환 |
| 6 | 결과를 캐시에 저장 (TTL: 5분~1시간) |
| 7 | JSON 형태로 프론트엔드에 응답 |
| 8 | 프론트엔드가 차트와 KPI 카드로 시각화 |

### 캐시 전략

| 데이터 유형 | 캐시 시간 | 이유 |
|------------|----------|------|
| 실시간 KPI | 5분 | 빠른 업데이트 필요 |
| 시간별 트래픽 | 15분 | 중간 수준 갱신 |
| 일별 통계 | 1시간 | 자주 변하지 않음 |

---

## 3. 인증 토큰 흐름

사용자 로그인부터 API 호출까지의 인증 흐름입니다.

### 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              인증 토큰 흐름                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │    로그인    │
                    └──────┬──────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  POST /api/admin/auth/login  │
              │  { email, password }   │
              └────────────┬───────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │   비밀번호 검증 (bcrypt)   │
              └────────────┬───────────┘
                           │
            ┌──────────────┴──────────────┐
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ Access Token  │              │ Refresh Token │
    │  (15분 유효)   │              │  (7일 유효)    │
    │ Authorization │              │ httpOnly      │
    │ 헤더에 포함    │              │ Cookie에 저장  │
    └───────────────┘              └───────────────┘
            │                              │
            └──────────────┬───────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │    API 요청 시 검증      │
              └────────────┬───────────┘
                           │
            ┌──────────────┴──────────────┐
            ▼                              ▼
    ┌───────────────┐              ┌───────────────┐
    │ 토큰 유효      │              │ 토큰 만료      │
    │   → 요청 처리  │              │   → 갱신 시도  │
    └───────────────┘              └───────────────┘
                                           │
                                           ▼
                                   ┌───────────────┐
                                   │ POST /refresh │
                                   │ 새 토큰 발급   │
                                   └───────────────┘
```

### 토큰 종류

| 토큰 | 유효 기간 | 저장 위치 | 용도 |
|------|----------|----------|------|
| Access Token | 15분 | 메모리 | API 인증 |
| Refresh Token | 7일 | httpOnly Cookie | Access Token 갱신 |

### 자동 갱신 흐름

1. Access Token 만료 감지
2. Refresh Token으로 `/api/admin/auth/refresh` 호출
3. 새 Access Token + Refresh Token 발급
4. 원래 요청 재시도

---

## 4. 배치 분석 파이프라인

매일 자동으로 실행되는 품질 분석 흐름입니다.

### 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            배치 분석 파이프라인                               │
└─────────────────────────────────────────────────────────────────────────────┘

      스케줄러
    (매일 오전 2시)
         │
         │ 1. 스케줄 트리거
         ▼
┌─────────────────┐
│   작업 생성      │
│ (BatchAnalysisJob)│
└────────┬────────┘
         │
         │ 2. 대상 로그 조회
         ▼
┌─────────────────┐
│   BigQuery      │
│  (전일 로그)     │
└────────┬────────┘
         │
         │ 3. 샘플링 (100건)
         ▼
┌─────────────────┐
│  각 로그마다:    │
│                 │
│  ┌───────────┐  │     ┌─────────────┐
│  │ 프롬프트   │──┼────>│   Gemini    │
│  │ 템플릿    │  │     │  (AI 분석)   │
│  └───────────┘  │     └──────┬──────┘
│                 │            │
│                 │     4. 분석 결과
│                 │            ▼
│  ┌───────────┐  │     ┌─────────────┐
│  │ 결과 저장  │<─┼─────│ JSON 파싱   │
│  │ (SQLite)  │  │     │ 점수 추출    │
│  └───────────┘  │     └─────────────┘
│                 │
└─────────────────┘
         │
         │ 5. 작업 완료
         ▼
┌─────────────────┐
│  상태 업데이트   │
│ COMPLETED/FAILED│
└─────────────────┘
```

### 단계별 설명

| 단계 | 설명 | 소요 시간 |
|------|------|----------|
| 1. 트리거 | 설정된 시간에 스케줄러가 작업 시작 | 즉시 |
| 2. 로그 조회 | BigQuery에서 전일 대화 로그 조회 | ~10초 |
| 3. 샘플링 | 설정된 개수만큼 랜덤 샘플링 | 즉시 |
| 4. AI 분석 | Gemini가 각 대화 품질 평가 | 1~3초/건 |
| 5. 결과 저장 | SQLite에 분석 결과 저장 | 즉시 |

### 분석 결과 구조

```
입력:
- user_input: "배송은 언제 오나요?"
- llm_response: "주문하신 상품은 내일 도착 예정입니다..."

AI 분석 결과:
{
  "qualityScore": 8,
  "relevance": 9,
  "completeness": 7,
  "clarity": 8,
  "sentiment": "neutral",
  "issues": ["배송 추적 링크 미제공"],
  "improvements": ["추적 URL 포함 권장"]
}
```

---

## 5. AI 챗봇 대화 흐름

플로팅 챗봇에서의 대화 처리 흐름입니다.

### 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AI 챗봇 대화 흐름                                  │
└─────────────────────────────────────────────────────────────────────────────┘

사용자                프론트엔드              백엔드                 Gemini
  │                      │                    │                      │
  │ 1. Ctrl+K (챗봇 열기) │                    │                      │
  │─────────────────────>│                    │                      │
  │                      │                    │                      │
  │ 2. 질문 입력          │                    │                      │
  │ "현재 에러율이 어때?"  │                    │                      │
  │─────────────────────>│                    │                      │
  │                      │                    │                      │
  │                      │ 3. POST /api/chatbot/chat               │
  │                      │ {                  │                      │
  │                      │   message: "...",  │                      │
  │                      │   pageContext: "/dashboard"               │
  │                      │ }                  │                      │
  │                      │───────────────────>│                      │
  │                      │                    │                      │
  │                      │                    │ 4. 현재 페이지 관련   │
  │                      │                    │    메트릭 조회        │
  │                      │                    │                      │
  │                      │                    │ 5. 프롬프트 구성      │
  │                      │                    │───────────────────────>
  │                      │                    │                      │
  │                      │                    │ 6. AI 응답 생성       │
  │                      │                    │<───────────────────────
  │                      │                    │                      │
  │                      │ 7. 응답 반환       │                      │
  │                      │<───────────────────│                      │
  │                      │                    │                      │
  │ 8. 마크다운 렌더링    │                    │                      │
  │<─────────────────────│                    │                      │
```

### 페이지 컨텍스트 매핑

챗봇은 현재 페이지에 따라 관련 메트릭을 자동으로 포함합니다.

| 페이지 | 자동 포함 메트릭 |
|--------|-----------------|
| `/dashboard` | 실시간 KPI, 시간별 트래픽 |
| `/dashboard/business` | 테넌트 사용량, 비용 트렌드 |
| `/dashboard/quality` | 토큰 효율성, FAQ 패턴 |
| `/dashboard/chatbot-quality` | 감정 분석, 재질문 패턴 |

### 예시

**사용자 질문** (품질 페이지에서):
> "FAQ로 등록하면 좋을 패턴 추천해줘"

**AI가 받는 컨텍스트**:
```json
{
  "page": "/dashboard/quality",
  "metrics": {
    "repeatedPatterns": [
      { "query": "비밀번호 변경", "count": 150 },
      { "query": "배송 조회", "count": 120 }
    ]
  }
}
```

**AI 응답**:
> "현재 데이터를 분석한 결과, 다음 패턴을 FAQ로 등록하시면 좋겠습니다:
> 1. **비밀번호 변경** (150회) - 가장 빈번한 질문
> 2. **배송 조회** (120회) - 두 번째로 많은 질문"

---

## 6. 이상 탐지 알림 흐름

비정상 패턴 감지 시 알림을 보내는 흐름입니다.

### 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            이상 탐지 알림 흐름                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│  스케줄러    │ (5분마다)
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│ 이상 탐지 서비스 │
│ (Z-Score 분석)  │
└────────┬────────┘
         │
         │ 데이터 조회
         ▼
┌─────────────────┐
│   BigQuery      │ 최근 1시간 데이터
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│          Z-Score 계산               │
│                                     │
│  Z = (현재값 - 평균) / 표준편차       │
│                                     │
│  |Z| > 2  → 주의                    │
│  |Z| > 3  → 이상                    │
└────────────────┬────────────────────┘
                 │
      ┌──────────┴──────────┐
      ▼                      ▼
┌───────────┐          ┌───────────┐
│ 정상      │          │ 이상 감지  │
│ (무시)    │          │           │
└───────────┘          └─────┬─────┘
                             │
                             ▼
                    ┌───────────────┐
                    │ Slack 알림    │
                    │ 발송          │
                    └───────────────┘
```

### 감지 대상

| 지표 | 감지 기준 | 예시 |
|------|----------|------|
| 토큰 사용량 | Z > 3 | 평소 1000 → 갑자기 5000 |
| 에러율 | 10% 초과 | 평소 2% → 갑자기 15% |
| 응답 시간 | Z > 3 | 평소 1초 → 갑자기 5초 |

### Slack 알림 예시

```
🚨 [OLA B2B Monitoring] 이상 탐지 알림

지표: 토큰 사용량
현재값: 5,230 tokens
평균값: 1,050 tokens
Z-Score: 3.98

테넌트: tenant-a
시간: 2025-01-19 14:30 KST

확인이 필요합니다.
```

---

## 관련 문서

- [프로젝트 개요](./01-overview.md) - 시스템 소개
- [시스템 아키텍처](./03-architecture.md) - 기술 구조
- [API 명세서](./04-api-reference.md) - API 상세
